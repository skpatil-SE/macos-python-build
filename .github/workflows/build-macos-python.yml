name: Build Portable Python for M-Series Macs

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    # 'macos-latest' is now the Apple Silicon runner (M1-M5 compatible)
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Portable Python (ARM64 Native)
        run: |
          # Targeting the latest stable 3.10 release for Apple Silicon
          URL="https://github.com/astral-sh/python-build-standalone/releases/download/20251009/cpython-3.10.19+20251009-aarch64-apple-darwin-install_only.tar.gz"
          curl -L $URL -o python_portable.tar.gz
          tar -xzf python_portable.tar.gz
          mv python python_m_series

      - name: Install dependencies
        run: |
          ./python_m_series/bin/python3 -m pip install --upgrade pip
          if [ -f "requirements.txt" ]; then
            ./python_m_series/bin/python3 -m pip install -r requirements.txt
          fi

      - name: Fix Relocatability
        run: |
          # Ensures 'pip' and other scripts work even if you rename the folder
          # Replaces the internal runner path with the generic /usr/bin/env python3
          grep -lR "/Users/runner" ./python_m_series/bin | xargs sed -i '' '1s|.*|#!/usr/bin/env python3|' || true

      - name: Package Folder
        run: |
          tar -czf python-portable-apple-silicon.tar.gz python_m_series

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: python-portable-apple-silicon
          path: python-portable-apple-silicon.tar.gz