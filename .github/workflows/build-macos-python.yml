name: Build Portable Python (Apple Silicon M-Series)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest # This is an M-series runner

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Portable Python (Native ARM64)
        run: |
          # Updated URL for 2026 stable release
          # Using -L to follow redirects and -f to fail if the link is broken
          URL="https://github.com/astral-sh/python-build-standalone/releases/download/20251217/cpython-3.10.19+20251217-aarch64-apple-darwin-install_only.tar.gz"
          
          echo "Downloading Python from $URL..."
          curl -L -f $URL -o python_portable.tar.gz
          
          # Check if the file is actually a gzip before extracting
          if file python_portable.tar.gz | grep -q "gzip compressed data"; then
            tar -xzf python_portable.tar.gz
            mv python python_m_series
          else
            echo "Error: Downloaded file is not a valid archive. Check the URL."
            cat python_portable.tar.gz # This will show the error message (e.g., Not Found)
            exit 1
          fi

      - name: Install dependencies
        run: |
          ./python_m_series/bin/python3 -m pip install --upgrade pip
          if [ -f "requirements.txt" ]; then
            ./python_m_series/bin/python3 -m pip install -r requirements.txt
          fi

      - name: Fix Relocatability (Crucial)
        run: |
          # Fixes shebangs in bin/ so the folder can be moved
          grep -lR "/Users/runner" ./python_m_series/bin | xargs sed -i '' '1s|.*|#!/usr/bin/env python3|' || true

      - name: Package for S3
        run: |
          tar -czf python-portable-m-series.tar.gz python_m_series

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: python-m-series
          path: python-portable-m-series.tar.gz